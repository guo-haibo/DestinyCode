@{
    Layout = null;
    ViewBag.Title = "编码解码";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" lang="en" content="This is a kind of language to express good intentions. To use this language, please visit destiny language website" />
    <meta name="description" lang="zh-CN" content="这是一门传达善意提醒的语言" />
    <meta http-equiv="keywords" content="命运语言,命运码,命运码解析,命运码生成" />
    <title>命运语言,命运与共</title>

    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">

    @Styles.Render("~/Content/indexHomeStyleSheet.css");

    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?630244f8bc41b45801dc5d46ac75fa2e";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



</head>

<body>
    <link href="https://cdn.bootcss.com/jquery-toast-plugin/1.3.2/jquery.toast.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>
    <div>
        <div class="mainDiv">

            <div class="contain2">
                <div class="lauBtnDiv">
                    <button id="lauBtn">EN</button>
                    <!-- <a id="lauBtn" class="waves-effect waves-light btn">EN</a> -->
                </div>
            </div>

            <br>
            <div class="contain1">
                <img class="contain1" src="~/Content/pic/cieclelogo.png" alt="" width="100" height="100">
            </div>
            <br>
            <div class="decodeDiv">
                <div class="contain1">
                    <label id="labledecode" class="infoLabel">-------- 解码 --------</label>
                </div>


                <div class="contain1">
                    <input id="inputfile" class="js_file" type="file" accept="image/jpg,image/jpeg,image/bmp,image/png,image/gif">
                    <label class="waves-effect waves-light btn" id="lableChosePic" class="lableBtn" for="inputfile">选择要解码的图片</label>
                </div>


                <div class="contain1">
                    <label id="decodeLabel">解码得到</label>
                </div>
                <div class="contain1">
                    <label id="resultStr">****</label>
                </div>
                <div class="imgContain">
                    <img id="imgPreview" class="imgPre" src="" alt="" width="100px" height="100px">
                </div>
            </div>

            <br>
            <!-- 编码部分 -->
            <div class="encodeDiv">
                <div class="contain1">
                    <label id="infoLabelEncode" class="infoLabel">-------- 编码 --------</label>
                </div>


                <!-- <div class="contain1">
                    <div class="row">
                        <form class="col s12">
                          <div class="row">
                            <div class="input-field col s12">
                              <textarea  id="inputStr" class="materialize-textarea" maxlength="120"></textarea>
                              <label for="inputStr" id="lable_input" >输入要编码的字符</label>
                            </div>
                          </div>
                        </form>
                    </div>
                </div> -->
                <div class="contain1">
                    <div class="row">
                        <form class="col s12">
                            <div class="row">
                                <div class="input-field col s12">
                                    <textarea id="inputStr" class="materialize-textarea" length="120" maxlength="120"></textarea>
                                    <label for="inputStr" id="lable_input">输入要编码的字符</label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>


                <div class="contain1">
                    <a id="decodeBtn" class="waves-effect waves-light btn">获取图片</a>
                </div>

                <div class="imgContain">
                    <img id="imgGet" class="imgdecode" src="" alt="" width="150px" height="150px">
                </div>
                <div class="contain1">
                    <label id="longPressLable" class="longPressLable">(长按或右键保存图片)</label>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
            var i = 0;
            function showLable(content) {
                var str = content.substr(0, i);
                str = str + "_";
                $('#resultStr').html(str);
                i++;
                if (i < content.length) {
                    setTimeout(function () { showLable(content); }, 200);
                }
                else {
                    i = 0;// 置零
                    $('#resultStr').html(content);// 完整显示
                }
            }

            function showEN() {
                $("#labledecode").html("------ Decode --------");
                $("#lableChosePic").html("Choose picture");
                $("#decodeLabel").html("Result");


                $("#infoLabelEncode").html("------ Encode --------");
                $("#lable_input").html("Enter your characters");
                $("#decodeBtn").html("Get picture")
                $("#longPressLable").html("(Long press or right click to save the picture)");
                document.title = "Destiny Language, Shared Destiny";

                $("#infoLabelDonate").html("------ Donation ------");
            }


            function showCN() {
                $("#labledecode").html("------ 解码 --------");
                $("#lableChosePic").html("选择要解码的图片");
                $("#decodeLabel").html("解码得到");


                $("#infoLabelEncode").html("------ 编码 --------");
                $("#lable_input").html("输入要编码的字符");
                $("#decodeBtn").html("获取图片")
                $("#longPressLable").html("(长按或右键保存图片)");
                document.title = "命运语言,命运与共";

                $("#infoLabelDonate").html("------ 捐助 ------");
            }

        </script>

        <script type="text/javascript">
            $(function () {
                // 允许上传的图片类型
                var allowTypes = ['image/jpg', 'image/jpeg', 'image/bmp', 'image/png', 'image/gif'];
                // 1024KB，也就是 1MB
                var maxSize = 1024 * 1024;
                // 图片最大宽度
                var maxWidth = 3000;
                //中英文切换

                if (navigator.language == "zh-CN") {
                    $("#lauBtn").html("EN");
                }
                else {
                    $("#lauBtn").html("中");
                    showEN();
                }

                $("#lauBtn").click(function () {
                    console.log("点击了中英文切换");
                    if ($("#lauBtn").html().indexOf("EN") != -1) {
                        // console.log ( $("#lauBtn").html() + "== "+"EN");
                        $("#lauBtn").html("中");
                        showEN();
                    }
                    else {
                        // console.log ( $("#lauBtn").html() + "== "+"EN");
                        $("#lauBtn").html("EN");
                        showCN();
                    }

                });


                // 编码处理
                $("#decodeBtn").click(function () {
                    var inputStr = $("#inputStr").val();
                    $("#imgGet").attr("src", "/Home/Getpic?inputStr=" + inputStr); //图片标签Id
                    $("#imgGet").css("visibility", "visible");// 移仓起来来
                    $("#longPressLable").css("visibility", "visible");// 移仓起来来
                });

                // 解码处理
                $('#inputfile').on('change', function (event) {
                    if ($("#lauBtn").html().indexOf("EN") != -1) {
                        $('#decodeLabel').html("正在解码...");
                    }
                    else {
                        $('#decodeLabel').html("Decoding...");
                    }

                    $("#decodeLabel").attr("class", "headerBox");            //
                    $("#imgPreview").css("visibility", "hidden");// 移仓起来来

                    var files = event.target.files;
                    // 如果没有选中文件，直接返回
                    if (files.length === 0) {
                        window.location.reload();
                        return;
                    }

                    for (var i = 0, len = files.length; i < len; i++) {// 因为 可能可以多选图片，需要遍历
                        var file = files[i];
                        var reader = new FileReader();

                        // 如果类型不在允许的类型范围内
                        if (allowTypes.indexOf(file.type) === -1) {
                            $.toast('error', 'forbidden');
                            window.location.reload();
                            continue;
                        }

                        if (file.size > maxSize) {
                            $.toast('error', 'forbidden');
                            window.location.reload();
                            continue;
                        }

                        reader.onload = function (e) {
                            var img = new Image();
                            img.onload = function () {
                                // 不要超出最大宽度
                                var w = Math.min(maxWidth, img.width);
                                // 高度按比例计算
                                var h = img.height * (w / img.width);
                                var canvas = document.createElement('canvas');
                                var ctx = canvas.getContext('2d');
                                // 设置 canvas 的宽度和高度
                                canvas.width = w;
                                canvas.height = h;
                                ctx.drawImage(img, 0, 0, w, h);
                                var base64 = canvas.toDataURL('image/png');
                                //console.log(base64)

                                $.ajax({
                                    type: 'POST',
                                    url: "/Home/Upload",
                                    // data to be added to query string:
                                    data: { name: base64 },
                                    // type of data we are expecting in return:
                                    dataType: 'json',
                                    timeout: 60000,
                                    context: $('body'),
                                    success: function (data) {
                                        if ($("#lauBtn").html().indexOf("EN") != -1) {
                                            $('#decodeLabel').html("解码得到:");
                                        }
                                        else {
                                            $('#decodeLabel').html("Result:");
                                        }
                                        showLable(data);
                                        $("#decodeLabel").removeClass("headerBox");

                                    },
                                    error: function (xhr, type) {
                                        if ($("#lauBtn").html().indexOf("EN") != -1) {
                                            $('#decodeLabel').html("服务器错误");
                                        }
                                        else {
                                            $('#decodeLabel').html("Server Error!");
                                        }
                                        $("#decodeLabel").removeClass("headerBox");
                                    }
                                })

                                var progress = 0;
                                function uploading() {
                                    // $preview.find('.tips').text(++progress + '%');
                                    if (progress < 100) {
                                        setTimeout(uploading, 60);
                                    }
                                    else {
                                        // 如果是失败，塞一个失败图标
                                        //$preview.find('.weui_uploader_status_content').html('<i class="weui_icon_warn"></i>');
                                        $(".tips").remove();
                                    }
                                }
                                setTimeout(uploading, 60);
                            };

                            // 插入到预览区
                            img.src = e.target.result;
                            $("#imgPreview").attr("src", e.target.result);
                            $("#imgPreview").css("visibility", "visible");// 显示出来

                        };

                        reader.readAsDataURL(file);
                    }
                });
            });
        </script>
        <!-- Compiled and minified JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
</body>
</html>

